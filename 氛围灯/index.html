<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>氛围灯全屏色板</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .canvas {
      position: fixed;
      inset: 0;
      background: #ffffff;
      transition: background-color 120ms ease;
    }

    .controls {
      position: fixed;
      left: 50%;
      bottom: env(safe-area-inset-bottom, 16px);
      transform: translateX(-50%);
      width: min(680px, 92vw);
      background: rgba(20, 20, 20, 0.6);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 14px 14px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      transition: opacity 200ms ease, transform 200ms ease;
    }

    .controls.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translate(-50%, 12px);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .row + .row {
      margin-top: 10px;
    }

    .group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type="color"] {
      appearance: none;
      width: 56px;
      height: 40px;
      border: none;
      border-radius: 10px;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }

    input[type="range"] {
      width: 100%;
      accent-color: #fff;
      cursor: pointer;
    }

    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      transition: transform 80ms ease, background 120ms ease, border-color 120ms ease;
    }

    .btn:active { transform: scale(0.98); }

    .chip {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      cursor: pointer;
    }

    /* 更醒目的下拉框（效果选择） */
    #effect {
      font-size: 16px;
      padding: 12px 16px;
      min-width: 220px;
      color: #ffffff;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
      background: rgba(0,0,0,0.55);
      border: 2px solid rgba(255,255,255,0.8);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.1);
      transition: box-shadow 160ms ease, border-color 160ms ease, background 160ms ease, transform 80ms ease;
    }

    #effect:hover { 
      background: rgba(0,0,0,0.68); 
      border-color: #ffffff;
    }

    #effect:focus { 
      outline: none; 
      box-shadow: 0 0 0 3px rgba(99, 179, 255, 0.55), 0 6px 18px rgba(0,0,0,0.5);
      border-color: #ffffff;
      background: rgba(0,0,0,0.68);
    }

    /* 下拉展开的选项提高可读性（部分浏览器支持） */
    #effect option { color: #000000; background: #ffffff; }

    /* 小屏优化：让选择器在窄屏依然显眼 */
    @media (max-width: 420px) {
      #effect { min-width: 180px; font-size: 15px; padding: 12px 14px; }
    }

    .floating-toggle {
      position: fixed;
      right: 16px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      transition: transform 80ms ease, opacity 180ms ease;
    }

    .floating-toggle:active { transform: scale(0.96); }

    .hint {
      text-align: center;
      opacity: 0.8;
      font-size: 12px;
      margin-top: 4px;
    }

    .credits { position: fixed; left: 8px; top: 8px; font-size: 11px; opacity: 0.5; }
  </style>
</head>
<body>
  <div id="canvas" class="canvas"></div>

  <div id="controls" class="controls">
    <div class="row">
      <div class="group">
        <button id="fullscreenBtn" class="btn">进入全屏</button>
        <button id="lockBtn" class="btn">隐藏面板</button>
        <button id="wakeBtn" class="btn">防息屏</button>
      </div>
      <input id="colorPicker" type="color" value="#ffffff" aria-label="选择颜色" />
    </div>

    <div class="row">
      <div class="group" style="min-width: 180px;">
        <span style="opacity:0.85; font-size: 14px;">效果</span>
      </div>
      <select id="effect" class="btn" style="width: 180px; text-align: left;">
        <option value="static">静态</option>
        <option value="breathe">呼吸</option>
        <option value="rainbow">渐变</option>
      </select>
    </div>

    <div class="row">
      <div class="group" style="min-width: 180px;">
        <span style="opacity:0.85; font-size: 14px;">亮度</span>
      </div>
      <input id="brightness" type="range" min="1" max="100" value="100" />
    </div>

    <div class="row">
      <div class="group" style="min-width: 180px;">
        <span style="opacity:0.85; font-size: 14px;">速度</span>
      </div>
      <input id="speed" type="range" min="1" max="200" value="60" />
    </div>

    <div class="row">
      <div class="group" style="grid-column: 1 / -1;">
        <button class="chip" data-color="#FF0000">红</button>
        <button class="chip" data-color="#00FF00">绿</button>
        <button class="chip" data-color="#0000FF">蓝</button>
        <button class="chip" data-color="#FFD8A8">暖白</button>
        <button class="chip" data-color="#E6F0FF">冷白</button>
        <button class="chip" data-color="#FF6B6B">珊瑚</button>
        <button class="chip" data-color="#B197FC">薰衣草</button>
        <button class="chip" data-color="#4DFFFF">薄荷</button>
      </div>
    </div>
    <div class="hint">提示：进入全屏后可隐藏面板，点击右下角圆钮可重新显示</div>
  </div>

  <button id="toggle" class="floating-toggle" title="显示/隐藏面板" aria-label="显示/隐藏面板">⚙️</button>
  <div class="credits">氛围灯 · 支持全屏与颜色选择</div>

  <script>
    (function() {
      const canvas = document.getElementById('canvas');
      const controls = document.getElementById('controls');
      const toggle = document.getElementById('toggle');
      const colorPicker = document.getElementById('colorPicker');
      const brightness = document.getElementById('brightness');
      const speed = document.getElementById('speed');
      const effect = document.getElementById('effect');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const lockBtn = document.getElementById('lockBtn');
      const wakeBtn = document.getElementById('wakeBtn');
      const themeMeta = document.querySelector('meta[name="theme-color"]');

      let wakeLock = null;
      let autoHideTimer = null;
      let rafId = null;
      let lastTs = null;

      function hexToRgb(hex) {
        const v = hex.replace('#','');
        const bigint = parseInt(v.length === 3 ? v.split('').map(c=>c+c).join('') : v, 16);
        return {
          r: (bigint >> 16) & 255,
          g: (bigint >> 8) & 255,
          b: bigint & 255
        };
      }

      function rgbToCss(r, g, b) { return `rgb(${r}, ${g}, ${b})`; }

      function rgbToHsl(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if (max === min) { h = s = 0; }
        else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 5.999999); break;
            case g: h = (b - r) / d + 2; break;
            default: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
      }

      function hslToCss(h, s, l) {
        return `hsl(${(h%360+360)%360}, ${Math.max(0, Math.min(100, s)).toFixed(1)}%, ${Math.max(0, Math.min(100, l)).toFixed(1)}%)`;
      }

      function applyColor(hex, level) {
        const { r, g, b } = hexToRgb(hex);
        const ratio = Math.max(0.01, Math.min(1, level / 100));
        const outR = Math.round(r * ratio);
        const outG = Math.round(g * ratio);
        const outB = Math.round(b * ratio);
        const css = rgbToCss(outR, outG, outB);
        canvas.style.backgroundColor = css;
        themeMeta && themeMeta.setAttribute('content', css);
      }

      function saveState() {
        try {
          const state = { color: colorPicker.value, brightness: brightness.value, speed: speed.value, effect: effect.value };
          localStorage.setItem('ambientLampState', JSON.stringify(state));
        } catch (e) {}
      }

      function loadState() {
        try {
          const state = JSON.parse(localStorage.getItem('ambientLampState'));
          if (state) {
            if (state.color) colorPicker.value = state.color;
            if (state.brightness) brightness.value = state.brightness;
            if (state.speed) speed.value = state.speed;
            if (state.effect) effect.value = state.effect;
          }
        } catch (e) {}
      }

      function update() {
        if (effect.value === 'static') {
          stopAnimation();
          applyColor(colorPicker.value, Number(brightness.value));
        } else {
          startAnimation();
        }
        saveState();
      }

      function stopAnimation() {
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        lastTs = null;
      }

      function startAnimation() {
        if (rafId) return;
        lastTs = null;
        const loop = (ts) => {
          if (lastTs == null) lastTs = ts;
          const dt = (ts - lastTs) / 1000;
          lastTs = ts;

          const baseHex = colorPicker.value;
          const baseBright = Number(brightness.value);
          const spd = Number(speed.value);

          if (effect.value === 'breathe') {
            // 频率：spd/60 Hz（spd=60 -> 1Hz）
            const freq = spd / 60;
            const t = ts / 1000;
            const phase = Math.sin(2 * Math.PI * freq * t);
            const factor = 0.6 + 0.4 * (0.5 * (phase + 1)); // 0.6..1.0
            applyColor(baseHex, Math.round(baseBright * factor));
          } else if (effect.value === 'rainbow') {
            const { r, g, b } = hexToRgb(baseHex);
            const hsl = rgbToHsl(r, g, b);
            // 色相速度：deg/s = spd * 2（spd=60 -> 120deg/s）
            const huePerSec = spd * 2;
            const t = ts / 1000;
            const h = hsl.h + huePerSec * t;
            const css = hslToCss(h, Math.max(60, hsl.s), Math.min(70, Math.max(35, hsl.l)));
            // 根据亮度滑块整体调整明度
            const lScaled = Math.max(1, Math.min(100, (baseBright / 100) * (parseFloat(css.match(/(\d+\.?\d*)%\)$/)[1]))));
            const finalCss = hslToCss(h, Math.max(60, hsl.s), lScaled);
            canvas.style.backgroundColor = finalCss;
            themeMeta && themeMeta.setAttribute('content', finalCss);
          }

          if (effect.value !== 'static') rafId = requestAnimationFrame(loop);
        };
        rafId = requestAnimationFrame(loop);
      }

      function scheduleAutoHide() {
        clearTimeout(autoHideTimer);
        autoHideTimer = setTimeout(() => {
          controls.classList.add('hidden');
        }, 3000);
      }

      function showControls() {
        controls.classList.remove('hidden');
        scheduleAutoHide();
      }

      function toggleControls() {
        if (controls.classList.contains('hidden')) {
          showControls();
        } else {
          controls.classList.add('hidden');
        }
      }

      async function enterFullscreen() {
        try {
          const el = document.documentElement;
          if (!document.fullscreenElement) {
            await el.requestFullscreen();
            fullscreenBtn.textContent = '退出全屏';
          } else {
            await document.exitFullscreen();
            fullscreenBtn.textContent = '进入全屏';
          }
        } catch (e) {
          alert('您的浏览器可能不支持全屏：' + e.message);
        }
      }

      async function requestWakeLock() {
        try {
          if ('wakeLock' in navigator && navigator.wakeLock.request) {
            if (!wakeLock) {
              wakeLock = await navigator.wakeLock.request('screen');
              wakeBtn.textContent = '取消防息屏';
              wakeLock.addEventListener('release', () => {
                wakeLock = null;
                wakeBtn.textContent = '防息屏';
              });
            } else {
              await wakeLock.release();
              wakeLock = null;
              wakeBtn.textContent = '防息屏';
            }
          } else {
            // 退化方案：通过视频保持活跃（不可保证）
            alert('当前环境不支持防息屏 API，请提高系统常亮时间或保持交互。');
          }
        } catch (e) {
          alert('申请防息屏失败：' + e.message);
        }
      }

      // 恢复状态并初始化
      loadState();
      update();
      scheduleAutoHide();

      // 事件绑定
      colorPicker.addEventListener('input', update);
      brightness.addEventListener('input', update);
      speed.addEventListener('input', update);
      effect.addEventListener('change', update);
      fullscreenBtn.addEventListener('click', enterFullscreen);
      lockBtn.addEventListener('click', () => controls.classList.add('hidden'));
      wakeBtn.addEventListener('click', requestWakeLock);
      toggle.addEventListener('click', toggleControls);
      canvas.addEventListener('click', () => controls.classList.add('hidden'));

      // 预设色
      document.querySelectorAll('.chip[data-color]').forEach(btn => {
        btn.addEventListener('click', () => {
          colorPicker.value = btn.getAttribute('data-color');
          update();
          scheduleAutoHide();
        });
      });

      // 全屏变化监听
      document.addEventListener('fullscreenchange', () => {
        fullscreenBtn.textContent = document.fullscreenElement ? '退出全屏' : '进入全屏';
      });

      // 任何交互重新计时自动隐藏
      ['mousemove','touchstart','keydown'].forEach(evt => {
        window.addEventListener(evt, () => {
          if (!controls.classList.contains('hidden')) scheduleAutoHide();
        }, { passive: true });
      });

      // iOS PWA/刘海屏安全区
      function setViewportHeightVar() {
        document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
      }
      setViewportHeightVar();
      window.addEventListener('resize', setViewportHeightVar);
    })();
  </script>
</body>
</html>


